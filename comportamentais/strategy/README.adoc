:imagesdir: ../../images/patterns/strategy
:source-highlighter: highlightjs
:numbered:
:unsafe:
:icons: font

ifdef::env-github[]
:outfilesuffix: .adoc
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]

= Padr√µes de Projetos Comportamentais

== Strategy (Estrat√©gia)

=== Defini√ß√£o

üìò"O padr√£o Strategy define uma fam√≠lia de algoritmos, encapsula cada um deles e os torna intercambi√°veis. A estrat√©gia deixa o algoritmo variar independentemente dos clientes que o utilizam" <<UCPP>>.

Em outras palavras, a partir de um conjunto de algoritmos, permite que classes possam trocar tais algoritmos por uma outra implementa√ß√£o, at√© mesmo em tempo de execu√ß√£o.

=== Aplicabilidade

Pode ser aplicado quando:

- o comportamento de um m√©todo (implementa√ß√£o de um algoritmo) precisa ser diferente em classes distintas e/ou mudar em tempo de execu√ß√£o;
- determinadas classes devem ter um comportamento espec√≠fico (m√©todo) e outras n√£o;
- n√£o deseja-se que uma altera√ß√£o em uma super classe afete sub classes.

=== Modelagem do Padr√£o

image::strategy-base-class-diagram.png[]

A classe `Estrategista` √© que que ir√° usar as estrat√©gias, que s√£o representadas pelas classes que implementam os comportamentos.
Cada comportamento (estrat√©gia) √© normalmente definido como uma interface. Assim, podem existir N implementa√ß√µes de cada comportamento (diferentes estrat√©gias).

Perceba que a rela√ß√£o entre a `Estrategista` e os comportamentos n√£o √© heran√ßa, mas pode ser uma associa√ß√£o normal, composi√ß√£o ou agrega√ß√£o. Cada comportamento n√£o √© implementado como uma subclasse da `Estrategista`, cada tipo de comportamento estar√° contido como um atributo dentro da `Estrategista`. Por isso √© comum representar como agrega√ß√£o/composi√ß√£o. Definindo o comportamento como atributo √© que nos permite alterar em tempo de execu√ß√£o sua implementa√ß√£o.

O comportamento em si √© definido por um m√©todo na interface. No exemplo, o m√©todo √© `executarComportamentoA()` para o `ComportamentoA`. O nome do m√©todo √© o desenvolvedor quem define, normalmente sendo um nome que fa√ßa sentido para o sistema.
A assinatura do m√©todo tamb√©m √© livre. Neste exemplo o m√©todo n√£o recebe par√¢metros e retorna um tipo gen√©rico `T`. O tipo do retorno vai depender das suas necessidades. Veja os exemplos concretos na se√ß√£o a seguir.

Podem existir diferentes classes filhas desta `Estrategista`. Cada classe filha podem ter comportamentos diferentes umas das outras.
Com o padr√£o Strategy, o comportamento de qualquer classe (m√£e ou filha) pode mudar em tempo de execu√ß√£o, de acordo com os requisitos do sistema.

Um projeto de exemplo para o diagrama apresentado est√° dispon√≠vel link:modelagem[aqui]. Ele deve ser alterado para incluir as mudan√ßas necess√°rias para o problema espec√≠fico que voc√™ estiver resolvendo com o padr√£o.

=== Princ√≠pios utilizados

- https://en.wikipedia.org/wiki/Composition_over_inheritance[Favorecer composi√ß√£o no lugar de heran√ßa].
- https://tuhrig.de/programming-to-an-interface/[Programar para uma "interface" n√£o uma implementa√ß√£o] (GoF): declaramos vari√°veis com tipos abstratos (uma interface de comportamento) e usamos tipos concretos (uma classe que implementa um comportamento) apenas na instancia√ß√£o.
- https://en.wikipedia.org/wiki/Open‚Äìclosed_principle[Open/Closed Principle (OCP)], pois separa as partes que mudam (os comportamentos) de dentro da classe que utiliza eles. Isto torna a classe "aberta para extens√£o e fechada para modifica√ß√£o" (em rela√ß√£o aos comportamentos).
- https://en.wikipedia.org/wiki/Single_responsibility_principle[Single Responsibility Principle (SRP)] pois a classe que usa os comportamentos n√£o tem a responsabilidade de implementar estes comportamentos. 
- https://en.wikipedia.org/wiki/Liskov_substitution_principle[Liskov Substitution Principle (LSP)] pois podemos substituir um comportamento por qualquer implementa√ß√£o dele, de forma transparente, at√© mesmo em tempo de execu√ß√£o, sem que sejam necess√°rias altera√ß√µes no c√≥digo interno da classe que utiliza tais comportamentos.
- https://en.wikipedia.org/wiki/Interface_segregation_principle[Interface Segregation Principle (ISP)], pois estamos definindo diferentes interfaces: uma para cada comportamento que pode ser implementado.

=== Exemplos

==== Leitura de arquivos de retorno de boletos banc√°rios.

Arquivos de retorno s√£o enviados pelos bancos √†s empresas, fornecendo uma lista de boletos
pagos por clientes, para que tais empresas possam registrar o pagamento desses boletos
em seus sistemas. Os bancos utilizam um arquivo de texto com campos de comprimento fixo, onde n√£o existe um caractere delimitador. Cada campo tem uma quantidade fixa de caracteres. Se o valor possui menos caracteres do que deveria, o tamanho √© completado com espa√ßos em branco.

Um aplica√ß√£o na empresa recebedora dos boletos deve ler tais arquivos para extrair os dados
e normalmente gravar em um banco de dados. Existem diferentes formatos para tais arquivos
e cada banco pode utilizar um formato diferente. Atualmente existem in√∫meros projetos em diferentes linguagens para fazer a leitura de tais arquivos, /retorno-boletophp[como este]. Vamos implementar um solu√ß√£o simplificada aqui apenas para efeitos did√°ticos.

NOTE: Apesar de atualmente termos formatos de arquivos mais utilizados como JSON e XML, formatos como o mencionado ainda s√£o bastante utilizados, principalmente no meio acad√™mico, por serem simples. Um outro exemplo de tais formatos s√£o os arquivos https://pt.wikipedia.org/wiki/Comma-separated_values[CSV]. Mas em aplica√ß√µes Web e mobile, o mais comum √© o uso de JSON e XML.

Para este exemplo, vamos considerar que o Banco do Brasil usa um tipo de arquivo onde cada linha com as informa√ß√µes sobre o pagamento de um boleto cont√©m os seguintes campos, separados por ponto-e-v√≠rgula:

1. id do boleto com 10 d√≠gitos
1. c√≥digo do banco onde o boleto foi pago, com 3 d√≠gitos
1. data vencimento no formato dd/mm/yyyy
1. data pagamento no formato dd/mm/yyyy
1. CPF do cliente com 11 d√≠gitos (sem . e -)
1. valor do boleto no formato decimal 10.2
1. multa por atraso no formato decimal 10.2
1. juros no formato no formato decimal 10.2

Mas digamos que voc√™ tamb√©m precisa receber arquivos do Bradesco que possui o seguinte formato:

1. id do boleto com 10 d√≠gitos
1. c√≥digo do banco onde o boleto foi pago, com 3 d√≠gitos
1. *ag√™ncia onde o boleto foi pago, com 6 d√≠gitos
1. *conta do cliente para poss√≠vel extorno de pagamento, com 9 d√≠gitos
1. data vencimento no formato dd/mm/yyyy
1. *data/hora pagamento no formato dd/mm/yyyy hh:nn:ss
1. *CPF do cliente com 11 d√≠gitos (com . e -)
1. valor do boleto no formato decimal 10.2
1. multa por atraso no formato decimal 10.2
1. juros no formato no formato decimal 10.2

*__Campos adicionais ou diferentes do formato anterior.__

Um diagrama de classes para tal implementa√ß√£o pode ser como abaixo.

image:retorno-boleto-class-diagram.png[]

O c√≥digo fonte com uma implementa√ß√£o de exemplo pode ser obtido link:retorno-boleto[aqui] (link:https://kinolien.github.io/gitzip/?download=/manoelcampos/padroes-projetos/tree/master/comportamentais/strategy/retorno-boleto[zip]).
Tente primeiro fazer sua implementa√ß√£o a partir da leitura do diagrama,
para depois analisar o c√≥digo disponibilizado.

NOTE: Uma implementa√ß√£o em Node.js est√° dispon√≠vel em link:javascript/retorno-boleto-js[retorno-boleto-js].

=== Detalhes de Implementa√ß√£o

Mesmo que uma classe n√£o tenha um determinado comportamento, como o definido pela interface `ComportamentoA`, haver√° uma associa√ß√£o entre a classe e o comportamento.
Se a classe n√£o precisar de uma implementa√ß√£o de tal comportamento, o atributo que representa a associa√ß√£o pode estar nulo. Ao tentar usar o comportamento √© gerada a exce√ß√£o `NullPointerException`.

Para resolver isso, podemos criar uma classe que tenha uma implementa√ß√£o vazia para o comportamento, ou seja, que n√£o faz nada. Isto normalmente pode ser implementado pelo padr√£o Null Object que veremos posteriormente.

Se a classe estrategista √© obrigada a ter um determinado comportamento,
para evitar `NullPointerException`, podemos n√£o incluir um construtor sem par√¢metros e inclui um que exija uma implementa√ß√£o de estrat√©gia a ser usada.

== Modelagem convencional sem o padr√£o Strategy

A modelagem convencional de diferentes comportamentos sem a aplica√ß√£o do padr√£o Strategy requer o uso de heran√ßa para os diferentes comportamentos e √© visualmente mais simples.
No entanto, tal implementa√ß√£o tem algumas caracter√≠sticas que podem ser um problema (ou n√£o), dependendo dos requisitos do seu sistema, por n√£o permitir:

- alterar um comportamento em tempo de execu√ß√£o;
- compartilhar implementa√ß√µes de um mesmo comportamento entre diferentes classes filhas, levando √† duplica√ß√£o de c√≥digo (que deve ser evitado ao m√°ximo);
- combinar comportamentos distintos em um s√≥, reaproveitando c√≥digo.

image:no-strategy-class-diagram.png[]

== Como **N√ÉO** implementar uma solu√ß√£o para um problema

Se o padr√£o n√£o for aplicado nem a solu√ß√£o com heran√ßa acima, uma outra solu√ß√£o normalmente √© implementada por meio de uma √∫nica classe. N√£o ser√° mostrado nem mesmo um diagrama, pois a solu√ß√£o seria composta de fato apenas por uma classe. Ela ent√£o teria m√©todos como `T executarComportamentoA()`. Todas as implementa√ß√µes deste "Comportamento A" seriam inclu√≠das no m√©todo citado.

Para o exemplo do retorno de boletos banc√°rios, isto significa que tal m√©todo seria algo como:

[source,java]
----
public void processar(String nomeArquivo){
    if(nomeArquivo.contains("banco-brasil")){
        //processa arquivo do Banco do Brasil
    }
    else if(nomeArquivo.contains("bradesco")){
        //processa arquivo do Bradesco
    }
}
----

Tal c√≥digo √© extremamente mais simples, tem uma √∫nica classe e tudo √© feito em um √∫nico m√©todo.
Apesar de parecer muito melhor por simplificar as coisas e dar a impress√£o que estamos usando o princ√≠pio https://pt.wikipedia.org/wiki/Princ√≠pio_KISS[KISS], n√£o chamaria esta solu√ß√£o de simples, mas simplista e ing√™nua. **Solu√ß√µes simplistas normalmente v√£o lhe trazer dores de cabe√ßa para manuten√ß√£o do software**.
Por isto, esta "solu√ß√£o" *√© totalmente n√£o recomendada*.

Considerando que podemos ter diferentes formatos de arquivos para bancos distintos e que precisamos processar arquivos de v√°rios bancos, esta solu√ß√£o apresenta alguns problemas. O m√©todo `processar`:

- vai ficar longo e possivelmente confuso;
- n√£o tem uma √∫nica responsabilidade (viola o princ√≠pio https://en.wikipedia.org/wiki/Single_responsibility_principle[SRP]), pois ele processa arquivos de diferentes bancos, no lugar de processar arquivos de um banco espec√≠fico;
- cada vez que um novo banco precisar ser inclu√≠do, o c√≥digo precisar√° ser alterado (viola o princ√≠pio https://en.wikipedia.org/wiki/Open‚Äìclosed_principle[OCP]).

O problema da viola√ß√£o do OCP √© o mais problem√°tico aqui. O uso de _if's_ (ou qualquer estrutura condicional como `switch`) para decidir qual algoritmo ser√° executado em cada situa√ß√£o deixa claro que uma nova condi√ß√£o precisar√° ser adicionada sempre que um novo banco precisar ser suportado. Se em outros lugares do sistema voc√™ precisa realizar outras tarefas com estes arquivos de retorno, tende-se a repetir esta mesma cadeia de _if's_. 
Por exemplo, se em um lugar do sistema voc√™ precisa processar os arquivos e incluir os dados em um banco de dados e em outro voc√™ precisa processar e gerar PDFs com comprovantes de pagamentos ou enviar emails de notifica√ß√£o, em cada um desses locais voc√™ precisar√° deste bloco de _if's_.
O problema surge quando voc√™ precisar incluir um novo banco e tiver que incluir um novo _if_ em cada um desses locais.
Voc√™ pode simplesmente esquecer de adicionar tal _if_ em todos os locais necess√°rios e o recurso funcionar em parte do sistema e em outras partes n√£o.

== Modelagem do Padr√£o utilizando Programa√ß√£o Funcional

Observando o diagrama base para a implementa√ß√£o do padr√£o Strategy, pode-se perceber que s√£o criadas muitas classes e interfaces. As classes implementando essas interfaces n√£o possuem atributos e t√™m apenas um √∫nico m√©todo que representa a implementa√ß√£o da estrat√©gia em si.

Gra√ßas √† Programa√ß√£o Funcional em diversas linguagens como Java 8+, JavaScript, Phython e outras, podemos simplificar este diagrama, e consequentemente a implementa√ß√£o, como mostra a figura a seguir.

image:strategy-base-funcional-class-diagram.png[]

Observe que n√£o temos mais as interfaces e classes espec√≠ficas dos comportamentos. Cada comportamento nada mais √© do que a implementa√ß√£o de um m√©todo (como o `executarComportamentoA()` do primeiro diagrama). O que precisamos de fato √© permitir a troca da implementa√ß√£o de tal m√©todo em tempo de execu√ß√£o. Mas para isso, usando Programa√ß√£o Orientada a Objetos, tivemos que primeiro criar um conjunto de classes e interfaces pra isso. 

Usando Programa√ß√£o Funcional podemos armazenar uma fun√ß√£o em uma vari√°vel, no lugar de ter que armazenar um objeto inteiro que possui apenas um √∫nico m√©todo. A partir de tal vari√°vel, podemos ent√£o chamar a fun√ß√£o. Se uma nova fun√ß√£o for atribu√≠da a tal vari√°vel, quando usarmos a vari√°vel novamente, estaremos chamando esta nova fun√ß√£o, como espera-se que o padr√£o Strategy funcione.

No diagrama, o atributo como `comportamentoA` √© do tipo `Function`, uma interface do Java 8+ (dentro muitas outras) que indica que o atributo cont√©m uma refer√™ncia para um m√©todo que a classe pode chamar, no lugar de armazenar um dado primitivo ou objeto convencional. Sendo que a refer√™ncia para o m√©todo est√° armazenada em um atributo, se tivermos um m√©todo como o `comportamentoA1` mostrado no primeiro diagrama, podemos armazenar uma refer√™ncia para tal m√©todo no atributo `comportamentoA`.
Se precisarmos fazer a super classe ou qualquer subclasse usar um comportamento diferente, podemos atribuir, por exemplo, o m√©todo `comportamentoA2` ao atributo `comportamentoA` em tempo de execu√ß√£o.

`Function` √© uma das interfaces em Java 8+ que permite representar m√©todos isolados e armazenar refer√™ncias deles em vari√°veis. 
Estas s√£o chamadas de interfaces funcionais. Lembre-se que interfaces s√£o como tipos. Assim como uma vari√°vel do tipo `int` indica que somente n√∫meros inteiros podem ser armazenados nela, uma interface funcional indica o tipo de m√©todos que podem ser atribu√≠dos a uma vari√°vel de tal tipo. 
Em outras palavras, tais interfaces indicam que assinatura um m√©todo deve ter para ser poss√≠vel atribu√≠-lo a uma vari√°vel cujo tipo √© uma interface funcional.

Uma vari√°vel `Function` indica que podemos atribuir a ela qualquer m√©todo que receba um √∫nico par√¢metro e retorne um determinado valor.
Se voltarmos ao exemplo dos boletos, a assinatura do nosso m√©todo que implementa os comportamentos de leitura dos arquivos de retorno √©:

[source,java]
----
List<Boleto> lerArquivo(String nomeArquivo)
----

Observe que tal fun√ß√£o/m√©todo recebe um par√¢metro (neste caso `String`) e retorna um valor (`List<Boleto>`).
Assim, uma fun√ß√£o como `lerArquivo` pode ent√£o ser atribu√≠da a uma vari√°vel do tipo `Function`.
Se voc√™ tiver um m√©todo com uma assinatura diferente e precisar armazenar tal m√©todo em um vari√°vel,
justamente para permitir trocar a implementa√ß√£o de tal m√©todo em tempo de execu√ß√£o usando Programa√ß√£o Funcional,
um ponto de partida √© estudar a documenta√ß√£o do pacote https://docs.oracle.com/javase/8/docs/api/java/util/function/package-summary.html[java.util.function] que descreve as interfaces funcionais padr√µes do Java 8+.

Programa√ß√£o funcional √© um assunto bastante extenso que poderia ser um curso totalmente a parte,
que envolve muitos conceitos novos. Existe muito material dispon√≠vel na internet. 
Mas √© dif√≠cil encontrar material gratuito, em portugu√™s e abrangentes.
Existe muito material em ingl√™s, mas novamente espalhado pela web.
Se desejarem aprofundar no assunto, acessem esta https://github.com/manoelcampos/sistemas-distribuidos/tree/master/projects/00-programacao-funcional[p√°gina].

O c√≥digo fonte do projeto usando programa√ß√£o funcional est√° dispon√≠vel link:retorno-boleto-funcional[aqui] (link:https://kinolien.github.io/gitzip/?download=/manoelcampos/padroes-projetos/tree/master/comportamentais/strategy/retorno-boleto-funcional[zip]).

NOTE: Em linguagens distintas, a forma de implementar o padr√£o Strategy usando programa√ß√£o funcional √© diferente.

== Padr√µes Relacionados

Padr√µes que possuem similaridades ou podem ser usados em conjunto:

- link:../template-method[Template Method]

== Onde o padr√£o √© usado no JDK

Um forma de identificar a aplica√ß√£o do padr√£o Strategy nas classes do JDK que voc√™ usa √© quando um m√©todo *requer uma interface que possui apenas um m√©todo a ser implementado*. Estas s√£o chamadas de interfaces funcionais a partir do Java 8 (que possivelmente est√£o anotadas com `@FunctionalInterface`). A implementa√ß√£o de tal interface n√£o √© fornecida pelo JDK mas por voc√™.
Voc√™ deve ent√£o fornecer um algoritmo (fun√ß√£o) que ser√° executado pela classe que estiver utilizando o padr√£o.

=== List.sort(Comparator<T> comparator)

Tal m√©todo da interface List permite ordenar os valores dentra da lista.
`Comparator` √© uma interface cujas implementa√ß√µes representam as estrat√©gias de ordena√ß√£o de uma lista. `Comparator` √© uma interface funcional, logo, conseguimos usar programa√ß√£o funcional para implementar as estrat√©gias apenas criando-se fun√ß√µes. Assim, n√£o temos que obrigatoriamente criar uma classe para cada estrat√©gia. Como podemos implementar ordena√ß√£o de uma infinidade de maneiras como:

- por ordem alfab√©tica crescente ou descrescente;
- utilizando algoritmos mais ou menos eficientes como Bubble Sort, Shell Sort, Quick Sort, etc

usar o padr√£o Strategy aqui faz todo o sentido. Podemos inclusive em um momento ordenar
uma lista de uma maneira e posteriormente decidirmos que queremos ordenar de outra maneira.

== Exerc√≠cios

=== Descontos

Considere que temos um sistema de vendas onde diferentes formas de desconto podem ser implementadas de acordo as promo√ß√µes vigentes, como em datas comemorativas. O sistema deve permitir o c√°lculo do desconto sobre a venda das seguintes maneiras:

- percentual de desconto definido (que pode vir de um banco de dados);
- percentual de desconto progressivo: `valor da compra/25`, n√£o podendo ultrapassar 20%;
- desconto de 15% na data de anivers√°rio do cliente;
// - desconto de 20% no segundo item do mesmo produto.

E como poder√≠amos implementar estes tipos de desconto sem utilizar Padr√µes de Projetos?
Quais os problemas que tal implementa√ß√£o traria?

=== Ordena√ß√£o de Listas

Ordenar uma lista de estudantes utilizando programa√ß√£o funcional no Java 8+.
O projeto dispon√≠vel link:ordenar-lista-base[aqui] (link:https://kinolien.github.io/gitzip/?download=/manoelcampos/padroes-projetos/tree/master/comportamentais/strategy/ordenar-lista-base[zip]) pode ser usado como base, pois ele gera uma lista de estudantes aleatoriamente.

=== Diferen√ßas da implementa√ß√£o puramente OO vs funcional

A p√°gina inicial do link:retorno-boleto-funcional[projeto funcional dispon√≠vel aqui] (link:https://kinolien.github.io/gitzip/?download=/manoelcampos/padroes-projetos/tree/master/comportamentais/strategy/retorno-boleto-funcional[zip]) apresenta algumas diferen√ßas
de implementa√ß√£o do padr√£o Strategy utilizando puramente programa√ß√£o orientada a objetos e outra vers√£o
utilizando programa√ß√£o funcional.

Descreva em detalhes qual a diferen√ßa em utilizar um atributo do tipo `LeituraRetorno` na implementa√ß√£o puramente OO
e um atributo do tipo `Function` na implementa√ß√£o funcional.
